//run with node path
//npm install node-nmap

function portScan(param) {
  var host = param['ip'];
  const nmap = require('node-nmap');
  nmap.nmapLocation = 'nmap';
  param['state'] = 'scanning';
  try {
    var portsOpen = new nmap.OsAndPortScan(host);

    portsOpen.on('complete', function(data){
      var reportList = [];
      var ports = data[0].openPorts;
      for (port in ports) {
        var report = {};
        var service = data[0].openPorts[port].service;
        var portNumber = data[0].openPorts[port].port;
        report['port'] = portNumber;
        //report['state'] = state; //state isnt really an option
        report['service'] = service;
        report['state'] = 'open';
        reportList.push(report);
      }
      console.log(reportList);
      param['state'] = 'scanned';
      param['report'] = JSON.stringify(reportList);
      return JSON.stringify(reportList);
    });

    portsOpen.on('error', function(error){
      console.log(error);
    });
  }

  catch(err) {
    console.log(err);
  }
}

var param = JSON.parse('{"ip":"127.0.0.1"}');
portScan(param);
